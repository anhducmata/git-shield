#!/bin/bash

echo "üîí git-shield: scanning for secrets..."

FILES=$(git diff --cached --name-only --diff-filter=ACM)

PATTERNS=(
  "AKIA[0-9A-Z]{16}"
  "ASIA[0-9A-Z]{16}"
  "AIza[0-9A-Za-z-_]{35}"
  "ghp_[A-Za-z0-9]{36}"
  "-----BEGIN PRIVATE KEY-----"
  "slack_token|xox[baprs]-[0-9a-zA-Z]+"
)

found=0

for file in $FILES; do
  if [[ -f $file ]]; then
    for pattern in "${PATTERNS[@]}"; do
      if grep -qE "$pattern" "$file"; then
        echo "‚ùå Potential secret found in $file (pattern: $pattern)"
        found=1
      fi
    done
  fi
done

if [ "$found" -eq 1 ]; then
  echo "‚ùå Commit blocked by git-shield. Remove secrets before committing."
  exit 1
else
  echo "‚úÖ No secrets found. Proceeding with commit."
fi
